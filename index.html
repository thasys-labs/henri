<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Henri von Einbeck – Bier-Sommelier</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;1,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0d0c0e;
      --bg2:       #131116;
      --gold:      #d4a843;
      --gold-mute: #7a5f28;
      --text:      #f0ebe3;
      --muted:     #635e58;
      --subtle:    rgba(255,255,255,0.05);
      --border:    rgba(255,255,255,0.07);
      --h-bubble:  #1c1714;
      --h-accent:  #d4a843;
      --u-bubble:  #141c12;
      --u-text:    #d4e8cc;
      --radius:    16px;
    }

    [data-theme="light"] {
      --bg:        #f5f3ef;
      --bg2:       #ffffff;
      --gold:      #b8922e;
      --gold-mute: #c9a84a;
      --text:      #1a1612;
      --muted:     #7a746c;
      --subtle:    rgba(0,0,0,0.03);
      --border:    rgba(0,0,0,0.08);
      --h-bubble:  #faf8f4;
      --h-accent:  #d4a843;
      --u-bubble:  #e8f0e4;
      --u-text:    #2a3a24;
    }

    [data-theme="gold"] {
      --bg:        #1a1508;
      --bg2:       #221c0e;
      --gold:      #e8bc4a;
      --gold-mute: #a07828;
      --text:      #f8f4e8;
      --muted:     #8a7a5a;
      --subtle:    rgba(232,188,74,0.05);
      --border:    rgba(232,188,74,0.12);
      --h-bubble:  #2a2210;
      --h-accent:  #e8bc4a;
      --u-bubble:  #1a2010;
      --u-text:    #d8e8c0;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-weight: 300;
      font-size: 15px;
      line-height: 1.6;
      overflow: hidden;
    }

    /* ── LAYOUT ── */
    .app {
      display: flex;
      flex-direction: row;
      height: 100dvh;
      max-width: 1100px;
      margin: 0 auto;
    }

    /* ── SIDEBAR ── */
    .sidebar {
      width: 196px;
      flex-shrink: 0;
      background: var(--bg2);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 28px 14px 20px;
      gap: 8px;
      overflow: hidden;
      position: relative;
    }

    .sidebar::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
    }

    .sidebar-logo {
      width: 120px;
      margin-bottom: 16px;
      flex-shrink: 0;
    }

    .sidebar-logo img {
      width: 100%;
      height: auto;
      display: block;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.5));
    }

    .sidebar-portrait {
      width: 164px;
      height: 205px;
      border-radius: 10px;
      overflow: hidden;
      background: #120e08;
      border: 1px solid var(--gold-mute);
      margin-bottom: 6px;
      flex-shrink: 0;
    }

    .sidebar-portrait svg { width: 100%; height: 100%; display: block; }
    .sidebar-portrait img { width: 100%; height: 100%; display: block; object-fit: cover; }

    .sidebar-info { display: flex; flex-direction: column; align-items: center; gap: 5px; }

    .sidebar-name {
      font-family: 'Playfair Display', serif;
      font-size: 0.95rem;
      color: var(--gold);
      text-align: center;
      line-height: 1.3;
    }

    .sidebar-title {
      font-size: 0.66rem;
      color: var(--muted);
      letter-spacing: 0.14em;
      text-transform: uppercase;
      text-align: center;
    }

    .sidebar-sep {
      width: 28px;
      height: 1px;
      background: var(--border);
      margin: 2px 0;
    }

    .sidebar-year {
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: 0.72rem;
      color: var(--gold-mute);
      text-align: center;
    }

    .sidebar-badge {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.65rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .sidebar-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #4caf6a;
      box-shadow: 0 0 5px #4caf6a88;
    }

    .theme-toggle {
      margin-top: auto;
      display: flex;
      gap: 6px;
      padding: 6px;
      background: var(--subtle);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .theme-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      transition: all 0.15s;
    }

    .theme-btn:hover {
      color: var(--text);
      background: var(--subtle);
    }

    .theme-btn.active {
      background: var(--gold);
      color: #0d0c0e;
      border-color: var(--gold);
    }

    [data-theme="light"] .theme-btn.active {
      color: #fff;
    }

    /* ── CHAT AREA ── */
    .chat-area {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── BEER PANEL ── */
    .beer-panel {
      flex-shrink: 0;
      width: 0;
      overflow: hidden;
      background: var(--bg2);
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .beer-panel.visible { width: 230px; }

    .beer-panel-inner {
      width: 230px;
      height: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
      box-shadow: inset 1px 0 0 0 var(--border);
    }

    .beer-img-box {
      width: 100%;
      height: 260px;
      background: radial-gradient(ellipse at 50% 60%, #221a0e 0%, #0d0c0e 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
    }

    .beer-img-box::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 70px;
      background: linear-gradient(transparent, var(--bg2));
      pointer-events: none;
    }

    .beer-img-box img {
      max-height: 230px;
      max-width: 78%;
      object-fit: contain;
      filter: drop-shadow(0 6px 24px rgba(212,168,67,0.25));
      animation: beerIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
    }

    @keyframes beerIn {
      from { opacity: 0; transform: translateY(16px) scale(0.9); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .beer-info {
      padding: 14px 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 9px;
    }

    .beer-style-tag {
      font-size: 0.61rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--gold);
      font-weight: 500;
    }

    .beer-name-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      color: var(--text);
      line-height: 1.25;
    }

    .beer-divider {
      height: 1px;
      background: var(--border);
    }

    .beer-note-text {
      font-size: 0.82rem;
      color: rgba(240,235,227,0.7);
      font-style: italic;
      line-height: 1.65;
    }

    [data-theme="light"] .beer-note-text {
      color: rgba(26,22,18,0.75);
    }

    .beer-pairing-row {
      display: flex;
      align-items: flex-start;
      gap: 7px;
      font-size: 0.8rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .beer-pairing-icon {
      flex-shrink: 0;
      margin-top: 1px;
      color: var(--gold-mute);
    }

    /* ── MOBILE ── */
    @media (max-width: 620px) {
      .app { flex-direction: column; }

      .sidebar {
        width: 100%;
        flex-direction: row;
        padding: 8px 12px;
        gap: 10px;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }

      .sidebar::before { display: none; }

      .sidebar-portrait {
        width: 36px;
        height: 44px;
        margin-bottom: 0;
        border-radius: 6px;
      }

      .sidebar-info { align-items: flex-start; flex: 1; }
      .sidebar-sep, .sidebar-year { display: none; }
      .sidebar-name { font-size: 0.82rem; text-align: left; }
      .sidebar-title { text-align: left; font-size: 0.6rem; }
      .sidebar-badge { display: none; }

      /* Compact theme toggle on mobile */
      .theme-toggle {
        margin-top: 0;
        padding: 4px;
        gap: 4px;
      }
      .theme-btn {
        width: 24px;
        height: 24px;
        font-size: 0.75rem;
      }
      .theme-btn svg {
        width: 12px;
        height: 12px;
      }

      /* Beer panel as centered modal on mobile */
      .beer-panel {
        display: flex;
        position: fixed;
        top: 50%;
        left: 50%;
        right: auto;
        bottom: auto;
        width: 90%;
        max-width: 320px;
        max-height: 80vh;
        border-radius: 16px;
        border: 1px solid var(--border);
        transform: translate(-50%, -50%) scale(0.9);
        opacity: 0;
        pointer-events: none;
        transition: transform 0.25s ease, opacity 0.25s ease;
        z-index: 1000;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      }

      .beer-panel.visible {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
        pointer-events: auto;
      }

      /* Dark overlay behind modal */
      .beer-overlay {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        z-index: 999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
      }

      .beer-overlay.visible {
        opacity: 1;
        pointer-events: auto;
      }

      .beer-img-box {
        height: 180px;
      }

      .beer-img-box img {
        max-height: 160px;
      }

      /* Close button for mobile beer panel */
      .beer-close {
        display: flex;
      }
    }

    /* Hide overlay on desktop */
    .beer-overlay {
      display: none;
    }

    /* Hide close button on desktop */
    .beer-close {
      display: none;
      position: absolute;
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg2);
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      align-items: center;
      justify-content: center;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .beer-close:hover {
      color: var(--gold);
      background: var(--bg);
    }

    /* ── MESSAGES ── */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    /* Date/label separators */
    .day-label {
      text-align: center;
      font-size: 0.7rem;
      color: var(--muted);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin: 8px 0 12px;
    }

    /* ── MESSAGE ROW ── */
    .msg {
      display: flex;
      gap: 10px;
      max-width: 82%;
      animation: fadeUp 0.2s ease both;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .msg.henri { align-self: flex-start; }
    .msg.user  { align-self: flex-end; flex-direction: row-reverse; }

    /* Small avatar – only show for Henri */
    .msg-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2a1e0a, #1a1206);
      border: 1px solid var(--gold-mute);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', serif;
      font-size: 0.75rem;
      color: var(--gold);
      flex-shrink: 0;
      margin-top: 2px;
    }

    .msg.user .msg-avatar { display: none; }

    .bubble {
      padding: 10px 14px;
      border-radius: var(--radius);
      font-size: 0.95rem;
      line-height: 1.65;
      position: relative;
    }

    .msg.henri .bubble {
      background: var(--h-bubble);
      border-left: 2px solid var(--h-accent);
      border-radius: 4px var(--radius) var(--radius) var(--radius);
      color: var(--text);
    }

    .msg.user .bubble {
      background: var(--u-bubble);
      border-radius: var(--radius) 4px var(--radius) var(--radius);
      color: var(--u-text);
    }

    /* ── MARKDOWN STYLES ── */
    .bubble p { margin: 0 0 0.6em 0; }
    .bubble p:last-child { margin-bottom: 0; }
    .bubble strong { font-weight: 600; color: var(--gold); }
    .bubble em { font-style: italic; }
    .bubble ul, .bubble ol { margin: 0.5em 0; padding-left: 1.4em; }
    .bubble li { margin: 0.25em 0; }
    .bubble code {
      background: var(--subtle);
      padding: 0.15em 0.4em;
      border-radius: 4px;
      font-size: 0.88em;
      font-family: 'Fira Code', 'SF Mono', monospace;
    }
    .bubble pre {
      background: var(--subtle);
      padding: 0.8em 1em;
      border-radius: 8px;
      overflow-x: auto;
      margin: 0.6em 0;
    }
    .bubble pre code {
      background: none;
      padding: 0;
    }
    .bubble a {
      color: var(--gold);
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .bubble blockquote {
      border-left: 2px solid var(--gold-mute);
      padding-left: 0.8em;
      margin: 0.5em 0;
      color: var(--muted);
      font-style: italic;
    }

    /* Stack bubbles from same sender closer */
    .msg.henri + .msg.henri,
    .msg.user  + .msg.user  { margin-top: -2px; }

    /* ── TYPING DOTS ── */
    .typing .bubble {
      display: flex;
      gap: 5px;
      align-items: center;
      padding: 14px 16px;
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--gold-mute);
      animation: pulse 1.3s ease-in-out infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.18s; }
    .dot:nth-child(3) { animation-delay: 0.36s; }

    @keyframes pulse {
      0%, 60%, 100% { transform: scale(1); opacity: 0.5; }
      30%            { transform: scale(1.4); opacity: 1; }
    }

    /* ── INPUT AREA ── */
    .input-wrap {
      flex-shrink: 0;
      padding: 14px 20px 18px;
      background: var(--bg2);
      border-top: 1px solid var(--border);
    }

    .input-inner {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      background: var(--subtle);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 8px 8px 8px 16px;
      transition: border-color 0.2s;
    }

    .input-inner:focus-within {
      border-color: var(--gold-mute);
    }

    #user-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      font-weight: 300;
      resize: none;
      min-height: 26px;
      max-height: 130px;
      line-height: 1.55;
      padding: 2px 0;
    }

    #user-input::placeholder { color: var(--muted); }

    #send-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: var(--gold);
      color: #0d0c0e;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.15s, transform 0.1s, opacity 0.15s;
    }

    #send-btn:hover:not(:disabled) { background: #e0b85a; }
    #send-btn:active:not(:disabled) { transform: scale(0.93); }
    #send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

    .input-hint {
      font-size: 0.68rem;
      color: var(--muted);
      text-align: center;
      margin-top: 8px;
      letter-spacing: 0.03em;
    }

    .input-hint a { color: var(--muted); text-decoration: none; }
    .input-hint a:hover { color: var(--gold); }

    /* ── ERROR ── */
    .error-msg {
      align-self: center;
      background: rgba(180, 60, 40, 0.15);
      border: 1px solid rgba(180, 60, 40, 0.3);
      color: #d08878;
      font-size: 0.82rem;
      padding: 8px 14px;
      border-radius: 8px;
      margin: 4px 0;
    }

    /* ── MULTIPLE CHOICE ── */
    .mc-card {
      flex: 1;
      background: var(--h-bubble);
      border-left: 2px solid var(--h-accent);
      border-radius: 4px var(--radius) var(--radius) var(--radius);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mc-question {
      font-size: 0.95rem;
      color: var(--text);
      line-height: 1.6;
    }

    .mc-options { display: flex; flex-direction: column; gap: 6px; }

    .mc-btn {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: 8px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 0.88rem;
      font-weight: 300;
      padding: 8px 12px;
      text-align: left;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s, color 0.15s;
      line-height: 1.4;
    }

    .mc-btn:hover:not(:disabled) {
      background: rgba(212,168,67,0.1);
      border-color: var(--gold-mute);
    }

    .mc-btn.selected {
      background: rgba(212,168,67,0.18);
      border-color: var(--gold);
      color: var(--gold);
    }

    .mc-btn:disabled:not(.selected) { opacity: 0.4; cursor: default; }

    .mc-divider {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.7rem;
      color: var(--muted);
      letter-spacing: 0.08em;
    }

    .mc-divider::before, .mc-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .mc-text-row {
      display: flex;
      gap: 6px;
    }

    .mc-text-input {
      flex: 1;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: 8px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 0.88rem;
      font-weight: 300;
      padding: 7px 10px;
      outline: none;
      transition: border-color 0.15s;
    }

    .mc-text-input:focus { border-color: var(--gold-mute); }
    .mc-text-input::placeholder { color: var(--muted); }
    .mc-text-input:disabled { opacity: 0.4; }

    .mc-text-btn {
      background: var(--gold);
      border: none;
      border-radius: 8px;
      width: 32px;
      height: 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: opacity 0.15s;
      color: #0d0c0e;
    }

    .mc-text-btn:hover:not(:disabled) { opacity: 0.8; }
    .mc-text-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  </style>
</head>
<body>

<div class="app">

  <aside class="sidebar">
    <div class="sidebar-logo">
      <img src="https://www.einbecker.de/files/einbecker/template/img/einbecker-logos/einbecker_logo_rgb_malz.svg" alt="Einbecker">
    </div>
    <div class="sidebar-portrait">
      <img id="henri-portrait" src="/assets/henri-dark.svg" alt="Henri von Einbeck">
    </div>
    <div class="sidebar-info">
      <div class="sidebar-name">Henri von Einbeck</div>
      <div class="sidebar-title">Bier-Sommelier</div>
      <div class="sidebar-sep"></div>
      <div class="sidebar-year">seit 1378</div>
      <div class="sidebar-badge">Verfügbar</div>
    </div>
    <div class="theme-toggle">
      <button class="theme-btn" data-theme="dark" title="Dunkel">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
      </button>
      <button class="theme-btn" data-theme="light" title="Hell">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
      </button>
      <button class="theme-btn" data-theme="gold" title="Gold">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
      </button>
    </div>
  </aside>

  <div class="chat-area">
  <div id="messages">
    <div class="day-label">Einbecker Brauhaus</div>
  </div>

  <div class="input-wrap">
    <div class="input-inner">
      <textarea
        id="user-input"
        placeholder="Befragen Sie Henri..."
        rows="1"
        autocomplete="off"
        spellcheck="true"
      ></textarea>
      <button id="send-btn" title="Absenden">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
    <p class="input-hint">
      Henri ist eine KI-Figur und inoffizieller Bier-Radgeber für die Einbecker Brauerei AG&nbsp;&middot;&nbsp;

    </p>
  </div><!-- .input-wrap -->
  </div><!-- .chat-area -->

  <!-- Overlay for mobile modal -->
  <div class="beer-overlay" id="beer-overlay"></div>

  <aside class="beer-panel" id="beer-panel">
    <button class="beer-close" id="beer-close" aria-label="Schließen">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
    <div class="beer-panel-inner">
      <div class="beer-img-box">
        <img id="beer-img" src="" alt="Bier" />
      </div>
      <div class="beer-info">
        <div class="beer-style-tag" id="beer-style"></div>
        <div class="beer-name-title" id="beer-name"></div>
        <div class="beer-divider"></div>
        <div class="beer-note-text" id="beer-note"></div>
        <div class="beer-pairing-row" id="beer-pairing-row" style="display:none">
          <svg class="beer-pairing-icon" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
          <span id="beer-pairing"></span>
        </div>
      </div>
    </div>
  </aside>

</div><!-- .app -->


<script>
  // ── Theme handling ─────────────────────────────────────────────
  const themeButtons = document.querySelectorAll('.theme-btn');
  const root = document.documentElement;

  function setTheme(theme) {
    if (theme === 'dark') {
      root.removeAttribute('data-theme');
    } else {
      root.setAttribute('data-theme', theme);
    }
    localStorage.setItem('henri-theme', theme);
    themeButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.theme === theme);
    });
    // Update Henri portrait
    const portrait = document.getElementById('henri-portrait');
    if (portrait) portrait.src = `/assets/henri-${theme}.svg`;
  }

  // Initialize theme from localStorage or default to dark
  const savedTheme = localStorage.getItem('henri-theme') || 'dark';
  setTheme(savedTheme);

  themeButtons.forEach(btn => {
    btn.addEventListener('click', () => setTheme(btn.dataset.theme));
  });

  // ── Beer panel close ───────────────────────────────────────────
  const beerPanel = document.getElementById('beer-panel');
  const beerOverlay = document.getElementById('beer-overlay');
  
  function closeBeerPanel() {
    beerPanel.classList.remove('visible');
    beerOverlay.classList.remove('visible');
  }
  
  function openBeerPanel() {
    beerPanel.classList.add('visible');
    beerOverlay.classList.add('visible');
  }

  document.getElementById('beer-close').addEventListener('click', closeBeerPanel);
  beerOverlay.addEventListener('click', closeBeerPanel);

  const messagesEl = document.getElementById('messages');
  const inputEl    = document.getElementById('user-input');
  const sendBtn    = document.getElementById('send-btn');

  // ── Beer data (loaded from local JSON) ──────────────────────────
  let BEER_DATA = {};
  
  // Load beer data on startup
  fetch('/assets/beers.json')
    .then(res => res.json())
    .then(data => { BEER_DATA = data; })
    .catch(err => console.error('Failed to load beer data:', err));

  function findBeer(name) {
    if (BEER_DATA[name]) return { name, ...BEER_DATA[name] };
    const lower = name.toLowerCase();
    for (const [key, data] of Object.entries(BEER_DATA)) {
      if (key.toLowerCase().includes(lower) || lower.includes(key.toLowerCase())) {
        return { name: key, ...data };
      }
    }
    return null;
  }

  const conversationHistory = [];
  let isLoading = false;

  // ── DOM helpers ────────────────────────────────────────────────
  function createBubble(role) {
    const isHenri = role === 'assistant';
    const wrapper = document.createElement('div');
    wrapper.className = `msg ${isHenri ? 'henri' : 'user'}`;
    if (isHenri) {
      const av = document.createElement('div');
      av.className = 'msg-avatar';
      av.textContent = 'H';
      wrapper.appendChild(av);
    }
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    wrapper.appendChild(bubble);
    messagesEl.appendChild(wrapper);
    scrollToBottom();
    return bubble;
  }

  function addMessage(role, text) {
    const bubble = createBubble(role);
    if (role === 'assistant') {
      bubble.innerHTML = marked.parse(text);
    } else {
      bubble.textContent = text;
    }
  }

  function addTypingIndicator() {
    const wrapper = document.createElement('div');
    wrapper.className = 'msg henri typing';
    wrapper.id = 'typing';
    const av = document.createElement('div');
    av.className = 'msg-avatar';
    av.textContent = 'H';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
    wrapper.appendChild(av);
    wrapper.appendChild(bubble);
    messagesEl.appendChild(wrapper);
    scrollToBottom();
  }

  function removeTypingIndicator() { document.getElementById('typing')?.remove(); }

  function showError(msg) {
    const el = document.createElement('div');
    el.className = 'error-msg';
    el.textContent = msg;
    messagesEl.appendChild(el);
    scrollToBottom();
    setTimeout(() => el.remove(), 6000);
  }

  function scrollToBottom() { messagesEl.scrollTop = messagesEl.scrollHeight; }

  // ── SSE stream ─────────────────────────────────────────────────
  // Returns { text: string, toolUse: {id, name, input} | null }
  async function streamChat(messages) {
    const res = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages }),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || `Fehler ${res.status}`);
    }

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let textBubble = null;
    let fullText = '';
    let toolUse = null;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const raw = line.slice(6).trim();
        if (raw === '[DONE]') continue;
        try {
          const parsed = JSON.parse(raw);
          if (parsed.error) throw new Error(parsed.error);

          if (parsed.text !== undefined) {
            if (!textBubble) {
              removeTypingIndicator();
              textBubble = createBubble('assistant');
            }
            fullText += parsed.text;
            textBubble.innerHTML = marked.parse(fullText);
            scrollToBottom();
          } else if (parsed.tool_use) {
            toolUse = parsed.tool_use;
            // Render show_beer immediately so panel opens while text streams
            if (toolUse.name === 'show_beer') {
              renderBeerPanel(toolUse.input);
            }
          }
        } catch (e) {
          if (!(e instanceof SyntaxError)) throw e;
        }
      }
    }
    return { text: fullText, toolUse };
  }

  // ── Beer panel ─────────────────────────────────────────────────
  function renderBeerPanel(input) {
    // Get beer data from local storage, fallback to tool input
    const beer = findBeer(input.name) || input;
    
    const imgEl = document.getElementById('beer-img');
    imgEl.src = beer.image || '';
    // Re-trigger animation by cloning the img
    const fresh = imgEl.cloneNode();
    imgEl.replaceWith(fresh);

    document.getElementById('beer-style').textContent = beer.style || '';
    document.getElementById('beer-name').textContent  = beer.name  || input.name || '';
    document.getElementById('beer-note').textContent  = beer.note  || '';
    const pairingRow = document.getElementById('beer-pairing-row');
    if (beer.pairing) {
      document.getElementById('beer-pairing').textContent = beer.pairing;
      pairingRow.style.display = 'flex';
    } else {
      pairingRow.style.display = 'none';
    }
    openBeerPanel();
  }

  // ── Multiple choice widget ─────────────────────────────────────
  function renderMultipleChoice(question, options, toolId) {
    removeTypingIndicator();
    const wrapper = document.createElement('div');
    wrapper.className = 'msg henri';
    const av = document.createElement('div');
    av.className = 'msg-avatar';
    av.textContent = 'H';
    const card = document.createElement('div');
    card.className = 'mc-card';
    const q = document.createElement('div');
    q.className = 'mc-question';
    q.textContent = question;
    card.appendChild(q);
    const opts = document.createElement('div');
    opts.className = 'mc-options';

    for (const option of options) {
      const btn = document.createElement('button');
      btn.className = 'mc-btn';
      btn.textContent = option;
      btn.addEventListener('click', () => {
        card.querySelectorAll('.mc-btn').forEach(b => { b.disabled = true; });
        btn.classList.add('selected');

        // Show selection as user bubble
        addMessage('user', option);

        // Add tool_result to history
        conversationHistory.push({
          role: 'user',
          content: [{ type: 'tool_result', tool_use_id: toolId, content: option }],
        });

        // Continue conversation
        isLoading = true;
        sendBtn.disabled = true;
        addTypingIndicator();
        handleResponse();
      });
      opts.appendChild(btn);
    }

    card.appendChild(opts);

    // ── "oder" + free-text input ──
    const divider = document.createElement('div');
    divider.className = 'mc-divider';
    divider.textContent = 'oder';
    card.appendChild(divider);

    const textRow = document.createElement('div');
    textRow.className = 'mc-text-row';

    const textInput = document.createElement('input');
    textInput.type = 'text';
    textInput.className = 'mc-text-input';
    textInput.placeholder = 'Eigene Antwort...';

    const textBtn = document.createElement('button');
    textBtn.className = 'mc-text-btn';
    textBtn.title = 'Absenden';
    textBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>';

    function submitCustom() {
      const val = textInput.value.trim();
      if (!val || isLoading) return;
      card.querySelectorAll('.mc-btn').forEach(b => { b.disabled = true; });
      textInput.disabled = true;
      textBtn.disabled = true;
      addMessage('user', val);
      conversationHistory.push({
        role: 'user',
        content: [{ type: 'tool_result', tool_use_id: toolId, content: val }],
      });
      isLoading = true;
      sendBtn.disabled = true;
      addTypingIndicator();
      handleResponse();
    }

    textBtn.addEventListener('click', submitCustom);
    textInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); submitCustom(); }
    });

    textRow.appendChild(textInput);
    textRow.appendChild(textBtn);
    card.appendChild(textRow);

    wrapper.appendChild(av);
    wrapper.appendChild(card);
    messagesEl.appendChild(wrapper);
    scrollToBottom();
    textInput.focus();
  }

  // ── Handle response (shared by send, greet, tool click) ────────
  async function handleResponse() {
    try {
      const { text, toolUse } = await streamChat(conversationHistory);

      // Build assistant message content
      const content = [];
      if (text) content.push({ type: 'text', text });
      if (toolUse) content.push({ type: 'tool_use', id: toolUse.id, name: toolUse.name, input: toolUse.input });
      if (content.length) conversationHistory.push({ role: 'assistant', content });

      if (toolUse?.name === 'show_beer') {
        // Show beer panel, then continue conversation to get Claude's follow-up text
        renderBeerPanel(toolUse.input);
        conversationHistory.push({
          role: 'user',
          content: [{ type: 'tool_result', tool_use_id: toolUse.id, content: 'Panel angezeigt' }],
        });
        addTypingIndicator();
        await handleResponse(); // Recurse to get follow-up
      } else if (toolUse?.name === 'multiple_choice') {
        renderMultipleChoice(toolUse.input.question, toolUse.input.options, toolUse.id);
      }
    } catch (e) {
      removeTypingIndicator();
      showError(e.message || 'Verbindungsfehler. Bitte versuchen Sie es erneut.');
    } finally {
      isLoading = false;
      sendBtn.disabled = false;
      inputEl.focus();
    }
  }

  // ── Input resize ───────────────────────────────────────────────
  inputEl.addEventListener('input', () => {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 130) + 'px';
  });

  // ── Send ───────────────────────────────────────────────────────
  async function send() {
    const text = inputEl.value.trim();
    if (!text || isLoading) return;
    isLoading = true;
    sendBtn.disabled = true;
    inputEl.value = '';
    inputEl.style.height = 'auto';
    addMessage('user', text);
    conversationHistory.push({ role: 'user', content: text });
    addTypingIndicator();
    await handleResponse();
  }

  sendBtn.addEventListener('click', send);
  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
  });

  // ── Greeting ───────────────────────────────────────────────────
  async function greet() {
    isLoading = true;
    sendBtn.disabled = true;
    addTypingIndicator();

    // Trigger message – not added to real history
    const trigger = [{ role: 'user', content: 'Begrüße mich kurz und stelle dich vor. Dann frage, womit du mir heute behilflich sein kannst.' }];

    try {
      const { text, toolUse } = await streamChat(trigger);
      
      // Build assistant message content
      const content = [];
      if (text) content.push({ type: 'text', text });
      if (toolUse) content.push({ type: 'tool_use', id: toolUse.id, name: toolUse.name, input: toolUse.input });
      if (content.length) conversationHistory.push({ role: 'assistant', content });

      if (toolUse?.name === 'show_beer') {
        renderBeerPanel(toolUse.input);
        conversationHistory.push({
          role: 'user',
          content: [{ type: 'tool_result', tool_use_id: toolUse.id, content: 'Panel angezeigt' }],
        });
        addTypingIndicator();
        await handleResponse(); // Continue to get follow-up
      } else if (toolUse?.name === 'multiple_choice') {
        renderMultipleChoice(toolUse.input.question, toolUse.input.options, toolUse.id);
      }
    } catch {
      removeTypingIndicator();
      const fallback = 'Ah... willkommen. Ich bin Henri von Einbeck, Bier-Sommelier seit Anno Domini 1378. Womit darf ich Ihnen heute zu Diensten sein?';
      conversationHistory.push({ role: 'assistant', content: [{ type: 'text', text: fallback }] });
      addMessage('assistant', fallback);
    } finally {
      isLoading = false;
      sendBtn.disabled = false;
      inputEl.focus();
    }
  }

  greet();
</script>
</body>
</html>
